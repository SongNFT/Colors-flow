{"ast":null,"code":"import n from \"queue-microtask\";\n\nfunction t() {\n  return (t = Object.assign || function (n) {\n    for (var t = 1; t < arguments.length; t++) {\n      var e = arguments[t];\n\n      for (var r in e) Object.prototype.hasOwnProperty.call(e, r) && (n[r] = e[r]);\n    }\n\n    return n;\n  }).apply(this, arguments);\n}\n\nfunction e(n, t) {\n  (null == t || t > n.length) && (t = n.length);\n\n  for (var e = 0, r = new Array(t); e < t; e++) r[e] = n[e];\n\n  return r;\n}\n\nfunction r(n, t, e) {\n  if (!n.s) {\n    if (e instanceof o) {\n      if (!e.s) return void (e.o = r.bind(null, n, t));\n      1 & t && (t = e.s), e = e.v;\n    }\n\n    if (e && e.then) return void e.then(r.bind(null, n, t), r.bind(null, n, 2));\n    n.s = t, n.v = e;\n    var i = n.o;\n    i && i(n);\n  }\n}\n\nvar o = function () {\n  function n() {}\n\n  return n.prototype.then = function (t, e) {\n    var o = new n(),\n        i = this.s;\n\n    if (i) {\n      var u = 1 & i ? t : e;\n\n      if (u) {\n        try {\n          r(o, 1, u(this.v));\n        } catch (n) {\n          r(o, 2, n);\n        }\n\n        return o;\n      }\n\n      return this;\n    }\n\n    return this.o = function (n) {\n      try {\n        var i = n.v;\n        1 & n.s ? r(o, 1, t ? t(i) : i) : e ? r(o, 1, e(i)) : r(o, 2, i);\n      } catch (n) {\n        r(o, 2, n);\n      }\n    }, o;\n  }, n;\n}();\n\nfunction i(n) {\n  return n instanceof o && 1 & n.s;\n}\n\nfunction u(n, t, e) {\n  for (var u;;) {\n    var c = n();\n    if (i(c) && (c = c.v), !c) return f;\n\n    if (c.then) {\n      u = 0;\n      break;\n    }\n\n    var f = e();\n\n    if (f && f.then) {\n      if (!i(f)) {\n        u = 1;\n        break;\n      }\n\n      f = f.s;\n    }\n\n    if (t) {\n      var s = t();\n\n      if (s && s.then && !i(s)) {\n        u = 2;\n        break;\n      }\n    }\n  }\n\n  var a = new o(),\n      l = r.bind(null, a, 2);\n  return (0 === u ? c.then(h) : 1 === u ? f.then(v) : s.then(d)).then(void 0, l), a;\n\n  function v(o) {\n    f = o;\n\n    do {\n      if (t && (s = t()) && s.then && !i(s)) return void s.then(d).then(void 0, l);\n      if (!(c = n()) || i(c) && !c.v) return void r(a, 1, f);\n      if (c.then) return void c.then(h).then(void 0, l);\n      i(f = e()) && (f = f.v);\n    } while (!f || !f.then);\n\n    f.then(v).then(void 0, l);\n  }\n\n  function h(n) {\n    n ? (f = e()) && f.then ? f.then(v).then(void 0, l) : v(f) : r(a, 1, f);\n  }\n\n  function d() {\n    (c = n()) ? c.then ? c.then(h).then(void 0, l) : h(c) : r(a, 1, f);\n  }\n}\n\nvar c = \"INIT\",\n    f = \"SUBSCRIBE\",\n    s = \"UNSUBSCRIBE\",\n    a = \"UPDATED\",\n    l = \"SNAPSHOT\",\n    v = \"EXIT\",\n    h = \"TERMINATE\",\n    d = \"object\" == typeof self && self.self === self && self || \"object\" == typeof global && global.global === global && global || \"object\" == typeof window && window.window === window && window;\nd.FCL_REGISTRY = null == d.FCL_REGISTRY ? {} : d.FCL_REGISTRY;\n\nvar R = 0,\n    b = function (n, t, e, r) {\n  return void 0 === r && (r = {}), new Promise(function (o, i) {\n    var u = r.expectReply || !1,\n        c = null != r.timeout ? r.timeout : 5e3;\n    u && c && setTimeout(function () {\n      return i(new Error(\"Timeout: \" + c + \"ms passed without a response.\"));\n    }, c);\n    var f = {\n      to: n,\n      from: r.from,\n      tag: t,\n      data: e,\n      timeout: c,\n      reply: o,\n      reject: i\n    };\n\n    try {\n      d.FCL_REGISTRY[n].mailbox.deliver(f), u || o(!0);\n    } catch (n) {\n      console.error(\"FCL.Actor -- Could Not Deliver Message\", f, n);\n    }\n  });\n},\n    S = function (n) {\n  delete d.FCL_REGISTRY[n];\n},\n    m = function (r, o) {\n  if (void 0 === o && (o = null), null == o && (o = ++R), null != d.FCL_REGISTRY[o]) return o;\n  var i, c;\n  d.FCL_REGISTRY[o] = {\n    addr: o,\n    mailbox: (c = [], {\n      deliver: function (n) {\n        try {\n          return c.push(n), i && (i(c.shift()), i = void 0), Promise.resolve();\n        } catch (n) {\n          return Promise.reject(n);\n        }\n      },\n      receive: function () {\n        return new Promise(function (n) {\n          var t = c.shift();\n          if (t) return n(t);\n          i = n;\n        });\n      }\n    }),\n    subs: new Set(),\n    kvs: {}\n  };\n  var f,\n      s = {\n    self: function () {\n      return o;\n    },\n    receive: function () {\n      return d.FCL_REGISTRY[o].mailbox.receive();\n    },\n    send: function (n, t, e, r) {\n      return void 0 === r && (r = {}), r.from = o, b(n, t, e, r);\n    },\n    sendSelf: function (n, t, e) {\n      d.FCL_REGISTRY[o] && b(o, n, t, e);\n    },\n    broadcast: function (n, t, r) {\n      void 0 === r && (r = {}), r.from = o;\n\n      for (var i, u = function (n, t) {\n        var r;\n\n        if (\"undefined\" == typeof Symbol || null == n[Symbol.iterator]) {\n          if (Array.isArray(n) || (r = function (n, t) {\n            if (n) {\n              if (\"string\" == typeof n) return e(n, void 0);\n              var r = Object.prototype.toString.call(n).slice(8, -1);\n              return \"Object\" === r && n.constructor && (r = n.constructor.name), \"Map\" === r || \"Set\" === r ? Array.from(n) : \"Arguments\" === r || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r) ? e(n, void 0) : void 0;\n            }\n          }(n))) {\n            r && (n = r);\n            var o = 0;\n            return function () {\n              return o >= n.length ? {\n                done: !0\n              } : {\n                done: !1,\n                value: n[o++]\n              };\n            };\n          }\n\n          throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n        }\n\n        return (r = n[Symbol.iterator]()).next.bind(r);\n      }(d.FCL_REGISTRY[o].subs); !(i = u()).done;) b(i.value, n, t, r);\n    },\n    subscribe: function (n) {\n      return null != n && d.FCL_REGISTRY[o].subs.add(n);\n    },\n    unsubscribe: function (n) {\n      return null != n && d.FCL_REGISTRY[o].subs.delete(n);\n    },\n    subscriberCount: function () {\n      return d.FCL_REGISTRY[o].subs.size;\n    },\n    hasSubs: function () {\n      return !!d.FCL_REGISTRY[o].subs.size;\n    },\n    put: function (n, t) {\n      null != n && (d.FCL_REGISTRY[o].kvs[n] = t);\n    },\n    get: function (n, t) {\n      var e = d.FCL_REGISTRY[o].kvs[n];\n      return null == e ? t : e;\n    },\n    delete: function (n) {\n      delete d.FCL_REGISTRY[o].kvs[n];\n    },\n    update: function (n, t) {\n      null != n && (d.FCL_REGISTRY[o].kvs[n] = t(d.FCL_REGISTRY[o].kvs[n]));\n    },\n    keys: function () {\n      return Object.keys(d.FCL_REGISTRY[o].kvs);\n    },\n    all: function () {\n      return d.FCL_REGISTRY[o].kvs;\n    },\n    where: function (n) {\n      return Object.keys(d.FCL_REGISTRY[o].kvs).reduce(function (e, r) {\n        var i;\n        return n.test(r) ? t({}, e, ((i = {})[r] = d.FCL_REGISTRY[o].kvs[r], i)) : e;\n      }, {});\n    },\n    merge: function (n) {\n      void 0 === n && (n = {}), Object.keys(n).forEach(function (t) {\n        return d.FCL_REGISTRY[o].kvs[t] = n[t];\n      });\n    }\n  };\n  return \"object\" == typeof r && (void 0 === (f = r) && (f = {}), r = function (n) {\n    try {\n      var t = function () {\n        var t = u(function () {\n          return 1;\n        }, void 0, function () {\n          return Promise.resolve(n.receive()).then(function (t) {\n            var e = function (e, r) {\n              try {\n                var o = function (e, r) {\n                  try {\n                    var o = function () {\n                      function e() {\n                        return Promise.resolve(f[t.tag](n, t, t.data || {})).then(function () {});\n                      }\n\n                      var r = function () {\n                        if (\"EXIT\" === t.tag) {\n                          var e = function () {\n                            if (\"function\" == typeof f.TERMINATE) return Promise.resolve(f.TERMINATE(n, t, t.data || {})).then(function () {});\n                          }();\n\n                          if (e && e.then) return e.then(function () {});\n                        }\n                      }();\n\n                      return r && r.then ? r.then(e) : e();\n                    }();\n                  } catch (n) {\n                    return r(n);\n                  }\n\n                  return o && o.then ? o.then(void 0, r) : o;\n                }(0, function (e) {\n                  console.error(n.self() + \" Error\", t, e);\n                });\n              } catch (n) {\n                return;\n              }\n\n              return o && o.then ? o.then(r.bind(null, !1), r.bind(null, !0)) : void 0;\n            }(0, function (n, t) {});\n\n            if (e && e.then) return e.then(function () {});\n          });\n        });\n        return t && t.then ? t.then(function () {}) : void 0;\n      },\n          e = function () {\n        if (\"function\" == typeof f.INIT) return Promise.resolve(f.INIT(n)).then(function () {});\n      }();\n\n      return Promise.resolve(e && e.then ? e.then(t) : t());\n    } catch (n) {\n      return Promise.reject(n);\n    }\n  }), n(function () {\n    try {\n      return Promise.resolve(r(s)).then(function () {\n        S(o);\n      });\n    } catch (n) {\n      return Promise.reject(n);\n    }\n  }), o;\n};\n\nfunction I(n, t, e) {\n  t(n);\n  var r = m(function (t) {\n    try {\n      var r;\n      return t.send(n, \"SUBSCRIBE\"), Promise.resolve(u(function () {\n        return !r && 1;\n      }, void 0, function () {\n        return Promise.resolve(t.receive()).then(function (o) {\n          if (\"@EXIT\" === o.tag) return t.send(n, \"UNSUBSCRIBE\"), void (r = 1);\n          e(o.data);\n        });\n      }));\n    } catch (n) {\n      return Promise.reject(n);\n    }\n  });\n  return function () {\n    return b(r, \"@EXIT\");\n  };\n}\n\nfunction E(n, t) {\n  return t(n), b(n, \"SNAPSHOT\", null, {\n    expectReply: !0,\n    timeout: 0\n  });\n}\n\nexport { v as EXIT, c as INIT, l as SNAPSHOT, f as SUBSCRIBE, h as TERMINATE, s as UNSUBSCRIBE, a as UPDATED, S as kill, b as send, E as snapshoter, m as spawn, I as subscriber };","map":{"version":3,"sources":["../src/index.js","../src/mailbox/index.js"],"names":["_Pact","prototype","INIT","then","onFulfilled","onRejected","result","SUBSCRIBE","state","UNSUBSCRIBE","this","s","callback","SNAPSHOT","EXIT","TERMINATE","_settle","v","e","self","global","window","root","FCL_REGISTRY","pid","o","_this","value","send","addr","tag","data","opts","Promise","reply","reject","expectReply","timeout","setTimeout","Error","payload","to","from","pact","mailbox","deliver","error","console","bind","kill","handlers","ctx","observer","letter","receive","thenable","spawn","fn","subs","Set","kvs","sendSelf","broadcast","subscribe","sub","add","unsubscribe","subscriberCount","size","hasSubs","put","key","get","fallback","delete","update","keys","Object","all","where","reduce","acc","pattern","test","merge","forEach","queueMicrotask","subscriber","address","spawnFn","_exit2","snapshoter","body","stage","shouldContinue","_isSettledPact","updateValue","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","recover","finalizer","queue","next","msg","push","shift","undefined","resolve"],"mappings":"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","sourcesContent":["import {mailbox as createMailbox} from \"./mailbox\"\nimport queueMicrotask from \"queue-microtask\"\n\nexport const INIT = \"INIT\"\nexport const SUBSCRIBE = \"SUBSCRIBE\"\nexport const UNSUBSCRIBE = \"UNSUBSCRIBE\"\nexport const UPDATED = \"UPDATED\"\nexport const SNAPSHOT = \"SNAPSHOT\"\nexport const EXIT = \"EXIT\"\nexport const TERMINATE = \"TERMINATE\"\n\nconst root =\n  (typeof self === \"object\" && self.self === self && self) ||\n  (typeof global === \"object\" && global.global === global && global) ||\n  (typeof window === \"object\" && window.window === window && window)\n\nroot.FCL_REGISTRY = root.FCL_REGISTRY == null ? {} : root.FCL_REGISTRY\nvar pid = 0b0\n\nconst DEFAULT_TIMEOUT = 5000\nconst DEFAULT_TAG = \"---\"\nexport const send = (addr, tag, data, opts = {}) =>\n  new Promise((reply, reject) => {\n    const expectReply = opts.expectReply || false\n    const timeout = opts.timeout != null ? opts.timeout : DEFAULT_TIMEOUT\n\n    if (expectReply && timeout) {\n      setTimeout(\n        () =>\n          reject(new Error(`Timeout: ${timeout}ms passed without a response.`)),\n        timeout\n      )\n    }\n\n    const payload = {\n      to: addr,\n      from: opts.from,\n      tag,\n      data,\n      timeout,\n      reply,\n      reject,\n    }\n\n    try {\n      root.FCL_REGISTRY[addr].mailbox.deliver(payload)\n      if (!expectReply) reply(true)\n    } catch (error) {\n      console.error(\"FCL.Actor -- Could Not Deliver Message\", payload, error)\n    }\n  })\n\nexport const kill = addr => {\n  delete root.FCL_REGISTRY[addr]\n}\n\nconst fromHandlers = (handlers = {}) => async ctx => {\n  if (typeof handlers[INIT] === \"function\") await handlers[INIT](ctx)\n  __loop: while (1) {\n    const letter = await ctx.receive()\n    try {\n      if (letter.tag === EXIT) {\n        if (typeof handlers[TERMINATE] === \"function\") {\n          await handlers[TERMINATE](ctx, letter, letter.data || {})\n        }\n        break __loop\n      }\n      await handlers[letter.tag](ctx, letter, letter.data || {})\n    } catch (error) {\n      console.error(`${ctx.self()} Error`, letter, error)\n    } finally {\n      continue __loop\n    }\n  }\n}\n\nexport const spawn = (fn, addr = null) => {\n  if (addr == null) addr = ++pid\n  if (root.FCL_REGISTRY[addr] != null) return addr\n\n  root.FCL_REGISTRY[addr] = {\n    addr,\n    mailbox: createMailbox(),\n    subs: new Set(),\n    kvs: {},\n  }\n\n  const ctx = {\n    self: () => addr,\n    receive: () => root.FCL_REGISTRY[addr].mailbox.receive(),\n    send: (to, tag, data, opts = {}) => {\n      opts.from = addr\n      return send(to, tag, data, opts)\n    },\n    sendSelf: (tag, data, opts) => {\n      if (root.FCL_REGISTRY[addr]) send(addr, tag, data, opts)\n    },\n    broadcast: (tag, data, opts = {}) => {\n      opts.from = addr\n      for (let to of root.FCL_REGISTRY[addr].subs) send(to, tag, data, opts)\n    },\n    subscribe: sub => sub != null && root.FCL_REGISTRY[addr].subs.add(sub),\n    unsubscribe: sub => sub != null && root.FCL_REGISTRY[addr].subs.delete(sub),\n    subscriberCount: () => root.FCL_REGISTRY[addr].subs.size,\n    hasSubs: () => !!root.FCL_REGISTRY[addr].subs.size,\n    put: (key, value) => {\n      if (key != null) root.FCL_REGISTRY[addr].kvs[key] = value\n    },\n    get: (key, fallback) => {\n      const value = root.FCL_REGISTRY[addr].kvs[key]\n      return value == null ? fallback : value\n    },\n    delete: key => {\n      delete root.FCL_REGISTRY[addr].kvs[key]\n    },\n    update: (key, fn) => {\n      if (key != null)\n        root.FCL_REGISTRY[addr].kvs[key] = fn(root.FCL_REGISTRY[addr].kvs[key])\n    },\n    keys: () => {\n      return Object.keys(root.FCL_REGISTRY[addr].kvs)\n    },\n    all: () => {\n      return root.FCL_REGISTRY[addr].kvs\n    },\n    where: pattern => {\n      return Object.keys(root.FCL_REGISTRY[addr].kvs).reduce((acc, key) => {\n        return pattern.test(key)\n          ? {...acc, [key]: root.FCL_REGISTRY[addr].kvs[key]}\n          : acc\n      }, {})\n    },\n    merge: (data = {}) => {\n      Object.keys(data).forEach(\n        key => (root.FCL_REGISTRY[addr].kvs[key] = data[key])\n      )\n    },\n  }\n\n  if (typeof fn === \"object\") fn = fromHandlers(fn)\n\n  queueMicrotask(async () => {\n    await fn(ctx)\n    kill(addr)\n  })\n\n  return addr\n}\n\n// Returns an unsubscribe function\n// A SUBSCRIBE handler will need to be created to handle the subscription event\n//\n//  [SUBSCRIBE]: (ctx, letter) => {\n//    ctx.subscribe(letter.from)\n//    ctx.send(letter.from, UPDATED, ctx.all())\n//  }\n//\nexport function subscriber(address, spawnFn, callback) {\n  spawnFn(address)\n  const EXIT = \"@EXIT\"\n  const self = spawn(async ctx => {\n    ctx.send(address, SUBSCRIBE)\n    while (1) {\n      const letter = await ctx.receive()\n      if (letter.tag === EXIT) {\n        ctx.send(address, UNSUBSCRIBE)\n        return\n      }\n      callback(letter.data)\n    }\n  })\n  return () => send(self, EXIT)\n}\n\n// Returns a promise that returns a result\n// A SNAPSHOT handler will need to be created to handle the snapshot event\n//\n//  [SNAPSHOT]: (ctx, letter) => {\n//    letter.reply(ctx.all())\n//  }\n//\nexport function snapshoter(address, spawnFn) {\n  spawnFn(address)\n  return send(address, SNAPSHOT, null, {expectReply: true, timeout: 0})\n}\n","export const mailbox = () => {\n  const queue = []\n  var next\n\n  return {\n    async deliver(msg) {\n      queue.push(msg)\n      if (next) {\n        next(queue.shift())\n        next = undefined\n      }\n    },\n\n    receive() {\n      return new Promise(function innerReceive(resolve) {\n        const msg = queue.shift()\n        if (msg) return resolve(msg)\n        next = resolve\n      })\n    },\n  }\n}\n"]},"metadata":{},"sourceType":"module"}